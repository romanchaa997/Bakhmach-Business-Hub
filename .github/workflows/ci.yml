name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run every day at 6 AM UTC
    - cron: '0 6 * * *'

jobs:
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Markdown files
        uses: avto-dev/markdown-lint@v1
        with:
          args: '**/*.md'
          ignore: 'node_modules'
      
      - name: Check for broken links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
  
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
  
  test:
    name: Test Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: '.github/**/*.yml'
          config_file: '.yamllint.yml'
      
      - name: Validate JSON files
        run: |
          find . -name '*.json' -not -path './node_modules/*' -exec echo "Validating {}" \;
          find . -name '*.json' -not -path './node_modules/*' -exec cat {} \; | jq empty
  
  build:
    name: Build & Deploy Docs
    runs-on: ubuntu-latest
    needs: [lint, security, test]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Generate project stats
        run: |
          echo "## Project Statistics" > stats.md
          echo "" >> stats.md
          echo "- Total commits: $(git rev-list --count HEAD)" >> stats.md
          echo "- Contributors: $(git log --format='%aN' | sort -u | wc -l)" >> stats.md
          echo "- Total files: $(find . -type f | wc -l)" >> stats.md
          echo "- Lines of documentation: $(find . -name '*.md' -exec cat {} \; | wc -l)" >> stats.md
          echo "- Last updated: $(date)" >> stats.md
      
      - name: Deploy to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          destination_dir: docs
  
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [lint, security, test, build]
    if: always()
    steps:
      - name: Check workflow status
        run: |
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "✅ CI/CD Pipeline completed successfully!"
          else
            echo "❌ CI/CD Pipeline failed!"
            exit 1
          fi
